<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Schreibereinsätze</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="teamUtils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: #ecf0f1; border: none; border-radius: 6px; cursor: pointer; }
        .tab.active { background: #3498db; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .search-bar { margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 6px; }
        .search-input { padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 4px; margin-right: 10px; width: 200px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background: #34495e; color: white; }
        .table tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; }
        .login-form { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error { color: #e74c3c; margin-top: 10px; }
        .success { color: #27ae60; margin-top: 10px; }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-form">
        <h2>Admin Login</h2>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" placeholder="Enter email">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="password" placeholder="Enter password">
        </div>
        <button class="btn btn-primary" onclick="login()">Login</button>
        <div id="loginError" class="error"></div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>Admin Panel - Schreibereinsätze</h1>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('games')">Games</button>
                <button class="tab" onclick="showTab('scorers')">Scorers</button>
                <a href="logs.html" class="tab" style="text-decoration: none; color: inherit;">Logs</a>
            </div>

            <!-- Games Tab -->
            <div id="gamesTab" class="tab-content active">
                <div class="search-bar">
                    <input type="text" id="gameSearch" class="search-input" placeholder="Search games..." oninput="filterGames()">
                    <button class="btn btn-success" onclick="showAddGameModal()">Add Game</button>
                </div>
                <div id="gamesTable"></div>
            </div>

            <!-- Scorers Tab -->
            <div id="scorersTab" class="tab-content">
                <div class="search-bar">
                    <input type="text" id="scorerSearch" class="search-input" placeholder="Search scorers..." oninput="filterScorers()">
                    <button class="btn btn-success" onclick="showAddScorerModal()">Add Scorer</button>
                </div>
                <div id="scorersTable"></div>
            </div>


        </div>
    </div>

    <!-- Add/Edit Game Modal -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('gameModal')">&times;</span>
            <h2 id="gameModalTitle">Add Game</h2>
            <form id="gameForm">
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" id="gameDate" required>
                </div>
                <div class="form-group">
                    <label>Time:</label>
                    <input type="time" id="gameTime" required>
                </div>
                <div class="form-group">
                    <label>Home Team:</label>
                    <input type="text" id="homeTeam" required>
                </div>
                <div class="form-group">
                    <label>Away Team:</label>
                    <input type="text" id="awayTeam" required>
                </div>
                <div class="form-group">
                    <label>Gym:</label>
                    <input type="text" id="gym">
                </div>
                <div class="form-group">
                    <label>Täfeler Team:</label>
                    <select id="taefelerTeam">
                        <option value="">Select Team</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Scorer Team:</label>
                    <select id="scorerTeam">
                        <option value="">Select Team</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Täfeler:</label>
                    <select id="taefelerId">
                        <option value="">Select Täfeler</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Scorer:</label>
                    <select id="scorerId">
                        <option value="">Select Scorer</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('gameModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Scorer Modal -->
    <div id="scorerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scorerModal')">&times;</span>
            <h2 id="scorerModalTitle">Add Scorer</h2>
            <form id="scorerForm">
                <div class="form-group">
                    <label>First Name:</label>
                    <input type="text" id="scorerFname" required>
                </div>
                <div class="form-group">
                    <label>Last Name:</label>
                    <input type="text" id="scorerLname" required>
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="scorerPhone" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="scorerEmail">
                </div>
                <div class="form-group">
                    <label>Teams (comma-separated):</label>
                    <input type="text" id="scorerTeams" placeholder="HU23-1, HU23-2">
                </div>
                <div class="form-group">
                    <label>Scorer Licence:</label>
                    <select id="scorerLicence">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('scorerModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let supabase;
        let currentUser = null;
        let games = [];
        let scorers = [];
        let teams = [];
        let editingId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('Configuration not loaded');
                }
                
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                await checkAuth();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loginError').textContent = 'Configuration error. Please check setup.';
            }
        });

        // Authentication
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                showAdminPanel();
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                currentUser = data.user;
                showAdminPanel();
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            hideAdminPanel();
        }

        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadData();
        }

        function hideAdminPanel() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'games') renderGamesTable();
            else if (tabName === 'scorers') renderScorersTable();
        }

        // Data loading
        async function loadData() {
            try {
                await Promise.all([
                    loadGames(),
                    loadScorers(),
                    loadTeams()
                ]);
                renderGamesTable();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadGames() {
            const { data, error } = await supabase
                .from('scorer_matches')
                .select('*')
                .order('date', { ascending: true });
            
            if (error) throw error;
            games = data || [];
        }

        async function loadScorers() {
            const { data, error } = await supabase
                .from('scorer_scorers')
                .select('*')
                .order('lname', { ascending: true });
            
            if (error) throw error;
            scorers = data || [];
        }

        async function loadTeams() {
            // Extract unique teams from games
            const teamSet = new Set();
            games.forEach(game => {
                if (game.home_team) teamSet.add(game.home_team);
                if (game.away_team) teamSet.add(game.away_team);
                if (game.taefeler_team) teamSet.add(game.taefeler_team);
                if (game.scorer_team) teamSet.add(game.scorer_team);
            });
            teams = Array.from(teamSet).sort();
        }

        // Rendering functions
        function renderGamesTable() {
            const container = document.getElementById('gamesTable');
            if (!games.length) {
                container.innerHTML = '<div class="loading">No games found</div>';
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Home Team</th>
                            <th>Away Team</th>
                            <th>Gym</th>
                            <th>Täfeler</th>
                            <th>Scorer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${games.map(game => `
                            <tr>
                                <td>${new Date(game.date).toLocaleDateString()}</td>
                                <td>${game.time || '-'}</td>
                                <td>${game.home_team || '-'}</td>
                                <td>${game.away_team || '-'}</td>
                                <td>${game.halle || '-'}</td>
                                <td>${getPersonName(game.taefeler_id, scorers) || '-'}</td>
                                <td>${getPersonName(game.scorer_id, scorers) || '-'}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editGame(${game.match_id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteGame(${game.match_id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function renderScorersTable() {
            const container = document.getElementById('scorersTable');
            if (!scorers.length) {
                container.innerHTML = '<div class="loading">No scorers found</div>';
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Teams</th>
                            <th>Scorer Licence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scorers.map(scorer => `
                            <tr>
                                <td>${scorer.fname} ${scorer.lname}</td>
                                <td>${scorer.phone || '-'}</td>
                                <td>${scorer.email || '-'}</td>
                                <td>${Array.isArray(scorer.teams) ? scorer.teams.join(', ') : scorer.teams || '-'}</td>
                                <td>${scorer.scorer_licence ? 'Yes' : 'No'}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editScorer(${scorer.id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteScorer(${scorer.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }



        // Helper functions
        function getPersonName(id, people) {
            if (!id) return null;
            const person = people.find(p => p.id === id);
            return person ? `${person.fname} ${person.lname}` : null;
        }

        function populateTeamDropdowns() {
            const taefelerTeam = document.getElementById('taefelerTeam');
            const scorerTeam = document.getElementById('scorerTeam');
            
            taefelerTeam.innerHTML = '<option value="">Select Team</option>';
            scorerTeam.innerHTML = '<option value="">Select Team</option>';
            
            teams.forEach(team => {
                taefelerTeam.innerHTML += `<option value="${team}">${team}</option>`;
                scorerTeam.innerHTML += `<option value="${team}">${team}</option>`;
            });
        }

        function populatePersonDropdowns() {
            const taefelerId = document.getElementById('taefelerId');
            const scorerId = document.getElementById('scorerId');
            
            taefelerId.innerHTML = '<option value="">Select Täfeler</option>';
            scorerId.innerHTML = '<option value="">Select Scorer</option>';
            
            scorers.forEach(person => {
                taefelerId.innerHTML += `<option value="${person.id}">${person.fname} ${person.lname}</option>`;
                scorerId.innerHTML += `<option value="${person.id}">${person.fname} ${person.lname}</option>`;
            });
        }

        // Modal functions
        function showAddGameModal() {
            editingId = null;
            document.getElementById('gameModalTitle').textContent = 'Add Game';
            document.getElementById('gameForm').reset();
            populateTeamDropdowns();
            populatePersonDropdowns();
            document.getElementById('gameModal').style.display = 'block';
        }

        function editGame(id) {
            editingId = id;
            const game = games.find(g => g.match_id === id);
            if (!game) return;

            document.getElementById('gameModalTitle').textContent = 'Edit Game';
            document.getElementById('gameDate').value = game.date;
            document.getElementById('gameTime').value = game.time || '';
            document.getElementById('homeTeam').value = game.home_team || '';
            document.getElementById('awayTeam').value = game.away_team || '';
            document.getElementById('gym').value = game.halle || '';
            document.getElementById('taefelerTeam').value = game.taefeler_team || '';
            document.getElementById('scorerTeam').value = game.scorer_team || '';
            document.getElementById('taefelerId').value = game.taefeler_id || '';
            document.getElementById('scorerId').value = game.scorer_id || '';

            populateTeamDropdowns();
            populatePersonDropdowns();
            document.getElementById('gameModal').style.display = 'block';
        }

        function showAddScorerModal() {
            editingId = null;
            document.getElementById('scorerModalTitle').textContent = 'Add Scorer';
            document.getElementById('scorerForm').reset();
            document.getElementById('scorerModal').style.display = 'block';
        }

        function editScorer(id) {
            editingId = id;
            const scorer = scorers.find(s => s.id === id);
            if (!scorer) return;

            document.getElementById('scorerModalTitle').textContent = 'Edit Scorer';
            document.getElementById('scorerFname').value = scorer.fname || '';
            document.getElementById('scorerLname').value = scorer.lname || '';
            document.getElementById('scorerPhone').value = scorer.phone || '';
            document.getElementById('scorerEmail').value = scorer.email || '';
            document.getElementById('scorerTeams').value = Array.isArray(scorer.teams) ? scorer.teams.join(', ') : scorer.teams || '';
            document.getElementById('scorerLicence').value = scorer.scorer_licence ? 'true' : 'false';

            document.getElementById('scorerModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingId = null;
        }

        // Form submissions
        document.getElementById('gameForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const gameData = {
                date: document.getElementById('gameDate').value,
                time: document.getElementById('gameTime').value,
                home_team: document.getElementById('homeTeam').value,
                away_team: document.getElementById('awayTeam').value,
                halle: document.getElementById('gym').value,
                taefeler_team: document.getElementById('taefelerTeam').value,
                scorer_team: document.getElementById('scorerTeam').value,
                taefeler_id: document.getElementById('taefelerId').value || null,
                scorer_id: document.getElementById('scorerId').value || null
            };

            try {
                if (editingId) {
                    const { error } = await supabase
                        .from('scorer_matches')
                        .update(gameData)
                        .eq('match_id', editingId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('scorer_matches')
                        .insert([gameData]);
                    if (error) throw error;
                }

                await loadGames();
                renderGamesTable();
                closeModal('gameModal');
            } catch (error) {
                alert('Error saving game: ' + error.message);
            }
        });

        document.getElementById('scorerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const scorerData = {
                fname: document.getElementById('scorerFname').value,
                lname: document.getElementById('scorerLname').value,
                phone: document.getElementById('scorerPhone').value,
                email: document.getElementById('scorerEmail').value || null,
                teams: document.getElementById('scorerTeams').value.split(',').map(t => t.trim()).filter(t => t),
                scorer_licence: document.getElementById('scorerLicence').value === 'true'
            };

            try {
                if (editingId) {
                    const { error } = await supabase
                        .from('scorer_scorers')
                        .update(scorerData)
                        .eq('id', editingId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('scorer_scorers')
                        .insert([scorerData]);
                    if (error) throw error;
                }

                await loadScorers();
                renderScorersTable();
                closeModal('scorerModal');
            } catch (error) {
                alert('Error saving scorer: ' + error.message);
            }
        });

        // Delete functions
        async function deleteGame(id) {
            if (!confirm('Are you sure you want to delete this game?')) return;
            
            try {
                const { error } = await supabase
                    .from('scorer_matches')
                    .delete()
                    .eq('match_id', id);
                
                if (error) throw error;
                
                await loadGames();
                renderGamesTable();
            } catch (error) {
                alert('Error deleting game: ' + error.message);
            }
        }

        async function deleteScorer(id) {
            if (!confirm('Are you sure you want to delete this scorer?')) return;
            
            try {
                const { error } = await supabase
                    .from('scorer_scorers')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await loadScorers();
                renderScorersTable();
            } catch (error) {
                alert('Error deleting scorer: ' + error.message);
            }
        }

        // Filter functions
        function filterGames() {
            const searchTerm = document.getElementById('gameSearch').value.toLowerCase();
            const filtered = games.filter(game => 
                (game.home_team && game.home_team.toLowerCase().includes(searchTerm)) ||
                (game.away_team && game.away_team.toLowerCase().includes(searchTerm)) ||
                (game.halle && game.halle.toLowerCase().includes(searchTerm))
            );
            renderFilteredGames(filtered);
        }

        function filterScorers() {
            const searchTerm = document.getElementById('scorerSearch').value.toLowerCase();
            const filtered = scorers.filter(scorer => 
                scorer.fname.toLowerCase().includes(searchTerm) ||
                scorer.lname.toLowerCase().includes(searchTerm) ||
                (scorer.teams && scorer.teams.some(team => team.toLowerCase().includes(searchTerm)))
            );
            renderFilteredScorers(filtered);
        }



        function renderFilteredGames(filteredGames) {
            const container = document.getElementById('gamesTable');
            if (!filteredGames.length) {
                container.innerHTML = '<div class="loading">No games found</div>';
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Home Team</th>
                            <th>Away Team</th>
                            <th>Gym</th>
                            <th>Täfeler</th>
                            <th>Scorer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredGames.map(game => `
                            <tr>
                                <td>${new Date(game.date).toLocaleDateString()}</td>
                                <td>${game.time || '-'}</td>
                                <td>${game.home_team || '-'}</td>
                                <td>${game.away_team || '-'}</td>
                                <td>${game.halle || '-'}</td>
                                <td>${getPersonName(game.taefeler_id, scorers) || '-'}</td>
                                <td>${getPersonName(game.scorer_id, scorers) || '-'}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editGame(${game.match_id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteGame(${game.match_id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function renderFilteredScorers(filteredScorers) {
            const container = document.getElementById('scorersTable');
            if (!filteredScorers.length) {
                container.innerHTML = '<div class="loading">No scorers found</div>';
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Teams</th>
                            <th>Scorer Licence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredScorers.map(scorer => `
                            <tr>
                                <td>${scorer.fname} ${scorer.lname}</td>
                                <td>${scorer.phone || '-'}</td>
                                <td>${scorer.email || '-'}</td>
                                <td>${Array.isArray(scorer.teams) ? scorer.teams.join(', ') : scorer.teams || '-'}</td>
                                <td>${scorer.scorer_licence ? 'Yes' : 'No'}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editScorer(${scorer.id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteScorer(${scorer.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }
    </script>
</body>
</html>
