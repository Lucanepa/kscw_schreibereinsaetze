<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Schreibereinsätze</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="teamUtils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: #ecf0f1; border: none; border-radius: 6px; cursor: pointer; }
        .tab.active { background: #3498db; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .search-bar { margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 6px; }
        .search-input { padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 4px; margin-right: 10px; width: 200px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background: #34495e; color: white; }
        .table tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; }
        .login-form { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error { color: #e74c3c; margin-top: 10px; }
        .success { color: #27ae60; margin-top: 10px; }
        .missing-assignment { color: #e74c3c; font-style: italic; }
        .person-not-found { color: #f39c12; font-style: italic; }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-form">
        <h2>Admin Panel Access</h2>
        <p style="text-align: center; margin-bottom: 20px; color: #7f8c8d; font-size: 14px;">
            Only users with admin privileges can access this panel.
        </p>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" placeholder="Enter email">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="password" placeholder="Enter password">
        </div>
        <button class="btn btn-primary" onclick="login()">Login</button>
        <div id="loginError" class="error"></div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>Admin Panel - Schreibereinsätze</h1>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('games', event)">Games</button>
                <button class="tab" onclick="showTab('scorers', event)">Scorers</button>
                <a href="logs.html" class="tab" style="text-decoration: none; color: inherit;">Logs</a>
            </div>

            <!-- Games Tab -->
            <div id="gamesTab" class="tab-content active">
                <div class="search-bar">
                    <input type="text" id="gameSearch" class="search-input" placeholder="Search games..." oninput="filterGames()">
                    <button class="btn btn-success" onclick="showAddGameModal()">Add Game</button>
                </div>
                <div id="gamesTable"></div>
            </div>

            <!-- Scorers Tab -->
            <div id="scorersTab" class="tab-content">
                <div class="search-bar">
                    <input type="text" id="scorerSearch" class="search-input" placeholder="Search scorers..." oninput="filterScorers()">
                    <button class="btn btn-success" onclick="showAddScorerModal()">Add Scorer</button>
                </div>
                <div id="scorersTable"></div>
            </div>


        </div>
    </div>

    <!-- Add/Edit Game Modal -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('gameModal')">&times;</span>
            <h2 id="gameModalTitle">Add Game</h2>
            <form id="gameForm">
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" id="gameDate" required>
                </div>
                <div class="form-group">
                    <label>Time:</label>
                    <input type="time" id="gameTime" required>
                </div>
                <div class="form-group">
                    <label>Home Team:</label>
                    <input type="text" id="homeTeam" required>
                </div>
                <div class="form-group">
                    <label>Away Team:</label>
                    <input type="text" id="awayTeam" required>
                </div>
                <div class="form-group">
                    <label>Gym:</label>
                    <input type="text" id="gym">
                </div>
                <div class="form-group">
                    <label>Täfeler Team:</label>
                    <select id="taefelerTeam">
                        <option value="">Select Team</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Scorer Team:</label>
                    <select id="scorerTeam">
                        <option value="">Select Team</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Täfeler:</label>
                    <select id="taefelerId">
                        <option value="">Select Täfeler</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Scorer:</label>
                    <select id="scorerId">
                        <option value="">Select Scorer</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('gameModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Scorer Modal -->
    <div id="scorerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scorerModal')">&times;</span>
            <h2 id="scorerModalTitle">Add Scorer</h2>
            <form id="scorerForm">
                <div class="form-group">
                    <label>First Name:</label>
                    <input type="text" id="scorerFname" required>
                </div>
                <div class="form-group">
                    <label>Last Name:</label>
                    <input type="text" id="scorerLname" required>
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="scorerPhone" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="scorerEmail">
                </div>
                <div class="form-group">
                    <label>Teams (comma-separated):</label>
                    <input type="text" id="scorerTeams" placeholder="HU23-1, HU23-2">
                </div>
                <div class="form-group">
                    <label>Scorer Licence:</label>
                    <select id="scorerLicence">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('scorerModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // ============================================================================
        // RLS POLICIES REQUIRED IN SUPABASE DATABASE
        // ============================================================================
        // 
        // 1. ENABLE RLS ON ALL TABLES:
        //    ALTER TABLE scorer_matches ENABLE ROW LEVEL SECURITY;
        //    ALTER TABLE scorer_scorers ENABLE ROW LEVEL SECURITY;
        //    ALTER TABLE scorer_edit_log ENABLE ROW LEVEL SECURITY;
        //
        // 2. scorer_matches TABLE POLICIES:
        //    -- Allow anonymous users to read games
        //    CREATE POLICY "Allow anonymous read access" ON scorer_matches
        //    FOR SELECT USING (true);
        //
        //    -- Allow anonymous users to update only assignments via function
        //    -- (No direct UPDATE policy needed - use the RPC function)
        //
        //    -- Admin users get full access
        //    CREATE POLICY "Admin full access" ON scorer_matches
        //    FOR ALL USING (
        //      auth.jwt() ->> 'user_metadata' ->> 'is_admin' = 'true'
        //    );
        //
        // 3. scorer_scorers TABLE POLICIES:
        //    -- Allow anonymous users to read basic info (id, fname, lname only)
        //    CREATE POLICY "Allow anonymous basic read" ON scorer_scorers
        //    FOR SELECT USING (true);
        //
        //    -- Admin users get full access
        //    CREATE POLICY "Admin full access" ON scorer_scorers
        //    FOR ALL USING (
        //      auth.jwt() ->> 'user_metadata' ->> 'is_admin' = 'true'
        //    );
        //
        // 4. scorer_edit_log TABLE POLICIES:
        //    -- Only admin users can read/write logs
        //    CREATE POLICY "Admin only access" ON scorer_edit_log
        //    FOR ALL USING (
        //      auth.jwt() ->> 'user_metadata' ->> 'is_admin' = 'true'
        //    );
        //
        // 5. CREATE THE ASSIGNMENT UPDATE FUNCTION:
        //    CREATE OR REPLACE FUNCTION update_scorer_assignments(
        //      match_id UUID,
        //      new_scorer_id UUID DEFAULT NULL,
        //      new_taefeler_id UUID DEFAULT NULL
        //    )
        //    RETURNS void
        //    LANGUAGE plpgsql
        //    SECURITY DEFINER
        //    AS $$
        //    BEGIN
        //      UPDATE scorer_matches 
        //      SET 
        //        scorer_id = COALESCE(new_scorer_id, scorer_id),
        //        taefeler_id = COALESCE(new_taefeler_id, taefeler_id)
        //      WHERE match_id = update_scorer_assignments.match_id;
        //    END;
        //    $$;
        //
        //    GRANT EXECUTE ON FUNCTION update_scorer_assignments TO anon;
        //
        // ============================================================================

        // Global variables
        let supabase;
        let currentUser = null;
        let games = [];
        let scorers = [];
        let teams = [];
        let editingId = null;

        // Helper function to escape HTML and prevent XSS
        function escapeHtml(text) {
            if (text == null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('DOM loaded, initializing...');
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('Configuration not loaded');
                }
                
                console.log('Supabase config found:', SUPABASE_CONFIG);
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                console.log('Supabase client created');
                await checkAuth();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loginError').textContent = 'Configuration error. Please check setup.';
            }
        });

        // Authentication
        async function checkAuth() {
            try {
                console.log('Checking authentication...');
                const { data: { user } } = await supabase.auth.getUser();
                console.log('Auth result:', user);
                if (user) {
                    // Check if user is admin from user_metadata
                    if (!user.user_metadata || !user.user_metadata.is_admin) {
                        console.log('User is not admin');
                        document.getElementById('loginError').textContent = 'Access denied. Admin privileges required.';
                        return;
                    }
                    
                    currentUser = user;
                    console.log('Admin user authenticated, showing admin panel');
                    showAdminPanel();
                } else {
                    console.log('No user found, staying on login form');
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                document.getElementById('loginError').textContent = 'Authentication error. Please try again.';
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                // Check if user is admin from user_metadata
                if (!data.user.user_metadata || !data.user.user_metadata.is_admin) {
                    // Sign out the user since they're not admin
                    await supabase.auth.signOut();
                    throw new Error('Access denied. Admin privileges required.');
                }
                
                currentUser = data.user;
                showAdminPanel();
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        }

        async function logout() {
            stopAdminStatusCheck();
            await supabase.auth.signOut();
            currentUser = null;
            hideAdminPanel();
        }

        function showAdminPanel() {
            console.log('Showing admin panel...');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            console.log('Admin panel displayed, loading data...');
            loadData();
            
            // Start periodic admin status check
            startAdminStatusCheck();
        }

        function hideAdminPanel() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            stopAdminStatusCheck();
        }

        // Admin status monitoring
        let adminStatusCheckInterval;

        function startAdminStatusCheck() {
            // Check admin status every 5 minutes
            adminStatusCheckInterval = setInterval(checkAdminStatus, 5 * 60 * 1000);
        }

        function stopAdminStatusCheck() {
            if (adminStatusCheckInterval) {
                clearInterval(adminStatusCheckInterval);
                adminStatusCheckInterval = null;
            }
        }

        async function checkAdminStatus() {
            try {
                if (!currentUser) return;
                
                // Check admin status from user metadata
                if (!currentUser.user_metadata || !currentUser.user_metadata.is_admin) {
                    console.log('User no longer has admin privileges');
                    await logout();
                    document.getElementById('loginError').textContent = 'Admin privileges revoked. Please log in again.';
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        // Verify admin status before sensitive operations
        async function verifyAdminStatus() {
            if (!currentUser) return false;
            
            try {
                // Check admin status from user metadata
                if (!currentUser.user_metadata || !currentUser.user_metadata.is_admin) {
                    await logout();
                    document.getElementById('loginError').textContent = 'Admin privileges revoked. Please log in again.';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error verifying admin status:', error);
                return false;
            }
        }

        // Tab management
        function showTab(tabName, event) {
            console.log('showTab called with:', tabName, event);
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'games') {
                console.log('Switching to games tab');
                renderGamesTable();
            } else if (tabName === 'scorers') {
                console.log('Switching to scorers tab');
                // Only show scorers tab for admin users
                if (!canAccessScorerData()) {
                    console.log('User not authorized to access scorers tab');
                    alert('You do not have permission to access the Scorers tab.');
                    return;
                }
                console.log('Current scorers array length:', scorers.length);
                // Ensure scorers are loaded before rendering
                if (scorers.length === 0) {
                    console.log('Scorers not loaded yet, loading...');
                    loadScorers().then(() => {
                        console.log('Scorers loaded, now rendering table');
                        renderScorersTable();
                    }).catch(error => {
                        console.error('Error loading scorers:', error);
                    });
                } else {
                    console.log('Scorers already loaded, rendering table');
                    renderScorersTable();
                }
            } else if (tabName === 'logs') {
                console.log('Switching to logs tab');
                // Only show logs tab for admin users
                if (!canAccessLogs()) {
                    console.log('User not authorized to access logs tab');
                    alert('You do not have permission to access the Logs tab.');
                    return;
                }
                // Redirect to logs.html
                window.location.href = 'logs.html';
            }
        }

        // Function to check if user can update assignments
        function canUpdateAssignments() {
            // Admin users can update everything
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.is_admin) {
                return true;
            }
            // Non-admin users can only update assignments
            return false;
        }

        // Function to check if user can access scorer data
        function canAccessScorerData() {
            // Admin users can access everything
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.is_admin) {
                return true;
            }
            // Non-admin users can only read scorer data (for assignments)
            return false;
        }

        // Function to check if user can access logs
        function canAccessLogs() {
            // Only admin users can access logs
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.is_admin) {
                return true;
            }
            return false;
        }

        // Enhanced data loading with permission checks
        async function loadData() {
            try {
                console.log('Loading all data...');
                
                // Always load games (needed for assignment updates)
                await loadGames();
                
                // Load scorers based on permissions
                if (canAccessScorerData()) {
                    await loadScorers();
                } else {
                    // For non-admin users, load only basic scorer info needed for assignments
                    await loadBasicScorerInfo();
                }
                
                await loadTeams();
                console.log('All data loaded successfully');
                console.log('Games:', games.length);
                console.log('Scorers:', scorers.length);
                console.log('Teams:', teams.length);
                renderGamesTable();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load basic scorer info for non-admin users (only what's needed for assignments)
        async function loadBasicScorerInfo() {
            try {
                console.log('Loading basic scorer info for non-admin users...');
                const { data, error } = await supabase
                    .from('scorer_scorers')
                    .select('id, fname, lname')
                    .order('lname', { ascending: true });
                
                if (error) {
                    console.error('Error loading basic scorer info:', error);
                    throw error;
                }
                
                scorers = data || [];
                console.log('Basic scorer info loaded:', scorers.length);
            } catch (error) {
                console.error('Exception in loadBasicScorerInfo:', error);
                throw error;
            }
        }

        // Enhanced scorer loading with admin check
        async function loadScorers() {
            try {
                console.log('Loading scorers...');
                
                // Check if user has permission to access full scorer data
                if (!canAccessScorerData()) {
                    console.log('User not authorized to access full scorer data');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('scorer_scorers')
                    .select('*')
                    .order('lname', { ascending: true });
                
                if (error) {
                    console.error('Error loading scorers:', error);
                    throw error;
                }
                
                scorers = data || [];
                console.log('Scorers loaded:', scorers.length, scorers);
            } catch (error) {
                console.error('Exception in loadScorers:', error);
                throw error;
            }
        }

        async function loadGames() {
            try {
                console.log('Loading games...');
                const { data, error } = await supabase
                    .from('scorer_matches')
                    .select('*')
                    .order('date', { ascending: true })
                    .order('time', { ascending: true });
                
                if (error) {
                    console.error('Error loading games:', error);
                    throw error;
                }
                
                games = data || [];
                console.log('Games loaded:', games.length);
            } catch (error) {
                console.error('Exception in loadGames:', error);
                throw error;
            }
        }

        async function loadTeams() {
            try {
                console.log('Loading teams...');
                // Extract unique teams from games
                const teamSet = new Set();
                games.forEach(game => {
                    if (game.home_team) teamSet.add(game.home_team);
                    if (game.away_team) teamSet.add(game.away_team);
                    if (game.taefeler_team) teamSet.add(game.taefeler_team);
                    if (game.scorer_team) teamSet.add(game.scorer_team);
                });
                teams = Array.from(teamSet).sort();
                console.log('Teams loaded:', teams.length, teams);
            } catch (error) {
                console.error('Exception in loadTeams:', error);
                throw error;
            }
        }

        // Rendering functions
        function renderGamesTable() {
            console.log('Rendering games table...');
            const container = document.getElementById('gamesTable');
            console.log('Games container:', container);
            console.log('Games array:', games);
            
            if (!games.length) {
                console.log('No games found, showing loading message');
                container.innerHTML = '<div class="loading">No games found</div>';
                return;
            }

            console.log('Creating games table with', games.length, 'games');
            
            // Clear container
            container.innerHTML = '';
            
            // Create table element
            const table = document.createElement('table');
            table.className = 'table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Date', 'Time', 'Game N', 'Gym', 'Täfeler (Team)', 'Scorer (Team)', 'Actions'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            games.forEach(game => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(game.date);
                row.appendChild(dateCell);
                
                // Time
                const timeCell = document.createElement('td');
                timeCell.textContent = formatTime(game.time);
                row.appendChild(timeCell);
                
                // Game N
                const gameNCell = document.createElement('td');
                gameNCell.textContent = game.gamen || `Game ${games.indexOf(game) + 1}`;
                row.appendChild(gameNCell);
                
                // Gym
                const gymCell = document.createElement('td');
                gymCell.textContent = game.halle || '-';
                row.appendChild(gymCell);
                
                // Täfeler
                const taefelerCell = document.createElement('td');
                let taefelerText;
                
                // Check if this is a combined scorer/täfeler game
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    taefelerText = getCombinedPersonWithTeam(game);
                    if (!taefelerText) {
                        taefelerText = `Missing assignment (${game.scorer_taefeler_team || 'Scorer/Täfeler'})`;
                    }
                } else {
                    taefelerText = getPersonWithTeam(game.taefeler_id, scorers, game.taefeler_team);
                }
                
                taefelerCell.textContent = taefelerText;
                if (taefelerText.includes('Missing assignment')) {
                    taefelerCell.className = 'missing-assignment';
                } else if (taefelerText === 'Person not found') {
                    taefelerCell.className = 'person-not-found';
                }
                row.appendChild(taefelerCell);
                
                // Scorer
                const scorerCell = document.createElement('td');
                let scorerText;
                
                // Check if this is a combined scorer/täfeler game
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    scorerText = getCombinedPersonWithTeam(game);
                    if (!scorerText) {
                        scorerText = `Missing assignment (${game.scorer_taefeler_team || 'Scorer/Täfeler'})`;
                    }
                } else {
                    scorerText = getPersonWithTeam(game.scorer_id, scorers, game.scorer_team);
                }
                
                scorerCell.textContent = scorerText;
                if (scorerText.includes('Missing assignment')) {
                    scorerCell.className = 'missing-assignment';
                } else if (scorerText === 'Person not found') {
                    scorerCell.className = 'person-not-found';
                }
                row.appendChild(scorerCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                
                renderActionButtons(game, actionsCell);
                
                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            // Add summary statistics
            const missingTaefeler = games.filter(game => {
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    // Combined game - check if scorer_taefeler_id is missing
                    return !game.scorer_taefeler_id;
                } else {
                    // Separate game - check if täfeler_id is missing
                    return !game.taefeler_id;
                }
            }).length;
            
            const missingScorer = games.filter(game => {
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    // Combined game - check if scorer_taefeler_id is missing
                    return !game.scorer_taefeler_id;
                } else {
                    // Separate game - check if scorer_id is missing when scorer_team is assigned
                    return game.scorer_team && game.scorer_team.trim() !== '' && !game.scorer_id;
                }
            }).length;
            
            const totalGames = games.length;
            
            if (missingTaefeler > 0 || missingScorer > 0) {
                const summaryDiv = document.createElement('div');
                summaryDiv.style.marginTop = '15px';
                summaryDiv.style.padding = '10px';
                summaryDiv.style.backgroundColor = '#fff3cd';
                summaryDiv.style.border = '1px solid #ffeaa7';
                summaryDiv.style.borderRadius = '4px';
                summaryDiv.style.color = '#856404';
                
                let summaryText = `Summary: ${totalGames} total games`;
                if (missingTaefeler > 0) {
                    summaryText += `, ${missingTaefeler} missing täfeler`;
                }
                if (missingScorer > 0) {
                    summaryText += `, ${missingScorer} missing scorer`;
                }
                
                summaryDiv.textContent = summaryText;
                container.appendChild(summaryDiv);
            }
            
            console.log('Games table rendered successfully');
        }

        function renderScorersTable() {
            console.log('Rendering scorers table...');
            const container = document.getElementById('scorersTable');
            console.log('Container:', container);
            console.log('Scorers array:', scorers);
            
            // Check if user has permission to view scorers
            if (!canAccessScorerData()) {
                container.innerHTML = '<div class="error">You do not have permission to view scorer data.</div>';
                return;
            }
            
            if (!scorers.length) {
                console.log('No scorers found, showing loading message');
                container.innerHTML = '<div class="loading">No scorers found</div>';
                return;
            }

            console.log('Creating table with', scorers.length, 'scorers');
            
            // Clear container
            container.innerHTML = '';
            
            // Create table element
            const table = document.createElement('table');
            table.className = 'table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Name', 'Phone', 'Email', 'Teams', 'Scorer Licence', 'Actions'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            scorers.forEach(scorer => {
                const row = document.createElement('tr');
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = `${scorer.fname} ${scorer.lname}`;
                row.appendChild(nameCell);
                
                // Phone
                const phoneCell = document.createElement('td');
                phoneCell.textContent = scorer.phone || '-';
                row.appendChild(phoneCell);
                
                // Email
                const emailCell = document.createElement('td');
                emailCell.textContent = scorer.email || '-';
                row.appendChild(emailCell);
                
                // Teams
                const teamsCell = document.createElement('td');
                teamsCell.textContent = Array.isArray(scorer.teams) ? scorer.teams.join(', ') : scorer.teams || '-';
                row.appendChild(teamsCell);
                
                // Scorer Licence
                const licenceCell = document.createElement('td');
                licenceCell.textContent = scorer.scorer_licence ? 'Yes' : 'No';
                row.appendChild(licenceCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => editScorer(scorer.id));
                actionsCell.appendChild(editBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteScorer(scorer.id));
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            console.log('Table rendered successfully');
        }



        // Helper functions
        function getPersonName(id, people) {
            if (!id) return null;
            const person = people.find(p => p.id === id);
            return person ? `${person.fname} ${person.lname}` : null;
        }

        function getPersonWithTeam(id, people, assignedTeam) {
            if (!id) {
                // Check if this is a combined scorer/täfeler game
                if (assignedTeam && assignedTeam.includes('scorer_taefeler')) {
                    return `Missing assignment (${assignedTeam})`;
                }
                return assignedTeam ? `Missing assignment (${assignedTeam})` : 'Missing assignment';
            }
            const person = people.find(p => p.id === id);
            if (!person) return 'Person not found';
            
            let displayText = `${person.fname} ${person.lname}`;
            if (assignedTeam) {
                displayText += ` (${assignedTeam})`;
            }
            return displayText;
        }

        // New function to handle combined scorer/täfeler assignments
        function getCombinedPersonWithTeam(game) {
            if (game.scorer_taefeler_id) {
                const person = scorers.find(p => p.id === game.scorer_taefeler_id);
                if (person) {
                    return `${person.fname} ${person.lname} (${game.scorer_taefeler_team || 'Scorer/Täfeler'})`;
                }
                return 'Person not found';
            }
            return null; // Not a combined game
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            return `${day}.${month}.${year}`;
        }

        function formatTime(timeString) {
            if (!timeString) return '-';
            // Extract HH:MM from time string (remove seconds if present)
            return timeString.substring(0, 5);
        }

        function populateTeamDropdowns() {
            const taefelerTeam = document.getElementById('taefelerTeam');
            const scorerTeam = document.getElementById('scorerTeam');
            
            // Clear existing options
            taefelerTeam.innerHTML = '<option value="">Select Team</option>';
            scorerTeam.innerHTML = '<option value="">Select Team</option>';
            
            teams.forEach(team => {
                const taefelerOption = document.createElement('option');
                taefelerOption.value = team;
                taefelerOption.textContent = team;
                taefelerTeam.appendChild(taefelerOption);
                
                const scorerOption = document.createElement('option');
                scorerOption.value = team;
                scorerOption.textContent = team;
                scorerTeam.appendChild(scorerOption);
            });
        }

        function populatePersonDropdowns() {
            const taefelerId = document.getElementById('taefelerId');
            const scorerId = document.getElementById('scorerId');
            
            // Clear existing options
            taefelerId.innerHTML = '<option value="">Select Täfeler</option>';
            scorerId.innerHTML = '<option value="">Select Scorer</option>';
            
            scorers.forEach(person => {
                const taefelerOption = document.createElement('option');
                taefelerOption.value = person.id;
                taefelerOption.textContent = `${person.fname} ${person.lname}`;
                taefelerId.appendChild(taefelerOption);
                
                const scorerOption = document.createElement('option');
                scorerOption.value = person.id;
                scorerOption.textContent = `${person.fname} ${person.lname}`;
                scorerId.appendChild(scorerOption);
            });
        }

        // Modal functions
        function showAddGameModal() {
            editingId = null;
            document.getElementById('gameModalTitle').textContent = 'Add Game';
            document.getElementById('gameForm').reset();
            populateTeamDropdowns();
            populatePersonDropdowns();
            document.getElementById('gameModal').style.display = 'block';
        }

        function editGame(id) {
            editingId = id;
            const game = games.find(g => g.match_id === id);
            if (!game) return;

            document.getElementById('gameModalTitle').textContent = 'Edit Game';
            populateTeamDropdowns();
            populatePersonDropdowns();
            document.getElementById('gameDate').value = game.date;
            document.getElementById('gameTime').value = game.time || '';
            document.getElementById('homeTeam').value = game.home_team || '';
            document.getElementById('awayTeam').value = game.away_team || '';
            document.getElementById('gym').value = game.halle || '';
            document.getElementById('taefelerTeam').value = game.taefeler_team || '';
            document.getElementById('scorerTeam').value = game.scorer_team || '';
            document.getElementById('taefelerId').value = game.taefeler_id || '';
            document.getElementById('scorerId').value = game.scorer_id || '';

            document.getElementById('gameModal').style.display = 'block';
        }

        function showAddScorerModal() {
            editingId = null;
            document.getElementById('scorerModalTitle').textContent = 'Add Scorer';
            document.getElementById('scorerForm').reset();
            document.getElementById('scorerModal').style.display = 'block';
        }

        function editScorer(id) {
            console.log('editScorer called with id:', id);
            editingId = id;
            const scorer = scorers.find(s => s.id === id);
            console.log('Found scorer:', scorer);
            if (!scorer) {
                console.log('No scorer found with id:', id);
                return;
            }

            document.getElementById('scorerModalTitle').textContent = 'Edit Scorer';
            document.getElementById('scorerFname').value = scorer.fname || '';
            document.getElementById('scorerLname').value = scorer.lname || '';
            document.getElementById('scorerPhone').value = scorer.phone || '';
            document.getElementById('scorerEmail').value = scorer.email || '';
            document.getElementById('scorerTeams').value = Array.isArray(scorer.teams) ? scorer.teams.join(', ') : scorer.teams || '';
            document.getElementById('scorerLicence').value = scorer.scorer_licence ? 'true' : 'false';

            document.getElementById('scorerModal').style.display = 'block';
            console.log('Edit modal displayed');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingId = null;
        }

        // Form submissions
        document.getElementById('gameForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!await verifyAdminStatus()) return; // Verify admin status
            
            const gameData = {
                date: document.getElementById('gameDate').value,
                time: document.getElementById('gameTime').value,
                home_team: document.getElementById('homeTeam').value,
                away_team: document.getElementById('awayTeam').value,
                halle: document.getElementById('gym').value,
                taefeler_team: document.getElementById('taefelerTeam').value,
                scorer_team: document.getElementById('scorerTeam').value,
                taefeler_id: document.getElementById('taefelerId').value || null,
                scorer_id: document.getElementById('scorerId').value || null
            };

            try {
                if (editingId) {
                    const { error } = await supabase
                        .from('scorer_matches')
                        .update(gameData)
                        .eq('match_id', editingId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('scorer_matches')
                        .insert([gameData]);
                    if (error) throw error;
                }

                await loadGames();
                renderGamesTable();
                closeModal('gameModal');
            } catch (error) {
                alert('Error saving game: ' + error.message);
            }
        });

        // Function to update scorer assignments (for non-admin users)
        async function updateScorerAssignments(matchId, scorerId, taefelerId) {
            try {
                // First, get the current game to check if it's a combined game
                const currentGame = games.find(g => g.match_id === matchId);
                if (!currentGame) {
                    throw new Error('Game not found');
                }

                // Check if this is a combined scorer/täfeler game
                if (currentGame.scorer_taefeler_id || currentGame.scorer_taefeler_team) {
                    // For combined games, we need to update the scorer_taefeler_id field
                    // Use the taefelerId parameter for combined games
                    const { error } = await supabase
                        .from('scorer_matches')
                        .update({ scorer_taefeler_id: taefelerId })
                        .eq('match_id', matchId);
                    
                    if (error) throw error;
                } else {
                    // For separate games, use the RPC function
                    const { data, error } = await supabase.rpc('update_scorer_assignments', {
                        match_id: matchId,
                        new_scorer_id: scorerId || null,
                        new_taefeler_id: taefelerId || null
                    });
                    
                    if (error) throw error;
                }
                
                // Refresh the games table to show updated assignments
                await loadGames();
                renderGamesTable();
                
                return { success: true };
            } catch (error) {
                console.error('Error updating scorer assignments:', error);
                return { success: false, error: error.message };
            }
        }

        // Function to check if user can update assignments
        function canUpdateAssignments() {
            // Admin users can update everything
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.is_admin) {
                return true;
            }
            // Non-admin users can only update assignments
            return false;
        }

        // Function to check if user can access scorer data
        function canAccessScorerData() {
            // Admin users can access everything
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.is_admin) {
                return true;
            }
            // Non-admin users can only read scorer data (for assignments)
            return false;
        }

        // Function to check if user can access logs
        function canAccessLogs() {
            // Only admin users can access logs
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.is_admin) {
                return true;
            }
            return false;
        }

        document.getElementById('scorerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!await verifyAdminStatus()) return; // Verify admin status
            
            const scorerData = {
                fname: document.getElementById('scorerFname').value,
                lname: document.getElementById('scorerLname').value,
                phone: document.getElementById('scorerPhone').value,
                email: document.getElementById('scorerEmail').value || null,
                teams: document.getElementById('scorerTeams').value.split(',').map(t => t.trim()).filter(t => t),
                scorer_licence: document.getElementById('scorerLicence').value === 'true'
            };

            try {
                if (editingId) {
                    const { error } = await supabase
                        .from('scorer_scorers')
                        .update(scorerData)
                        .eq('id', editingId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('scorer_scorers')
                        .insert([scorerData]);
                    if (error) throw error;
                }

                await loadScorers();
                renderScorersTable();
                closeModal('scorerModal');
            } catch (error) {
                alert('Error saving scorer: ' + error.message);
            }
        });

        // Delete functions
        async function deleteGame(id) {
            if (!await verifyAdminStatus()) return; // Verify admin status
            if (!confirm('Are you sure you want to delete this game?')) return;
            
            try {
                const { error } = await supabase
                    .from('scorer_matches')
                    .delete()
                    .eq('match_id', id);
                
                if (error) throw error;
                
                await loadGames();
                renderGamesTable();
            } catch (error) {
                alert('Error deleting game: ' + error.message);
            }
        }

        async function deleteScorer(id) {
            console.log('deleteScorer called with id:', id);
            if (!await verifyAdminStatus()) return; // Verify admin status
            if (!confirm('Are you sure you want to delete this scorer?')) return;
            
            try {
                console.log('Deleting scorer from database...');
                const { error } = await supabase
                    .from('scorer_scorers')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }
                
                console.log('Scorer deleted successfully');
                await loadScorers();
                renderScorersTable();
            } catch (error) {
                console.error('Error in deleteScorer:', error);
                alert('Error deleting scorer: ' + error.message);
            }
        }

        // Filter functions
        function filterGames() {
            const searchTerm = document.getElementById('gameSearch').value.toLowerCase();
            const filtered = games.filter(game => 
                (game.home_team && game.home_team.toLowerCase().includes(searchTerm)) ||
                (game.away_team && game.away_team.toLowerCase().includes(searchTerm)) ||
                (game.halle && game.halle.toLowerCase().includes(searchTerm))
            );
            renderFilteredGames(filtered);
        }

        function filterScorers() {
            const searchTerm = document.getElementById('scorerSearch').value.toLowerCase();
            const filtered = scorers.filter(scorer => 
                scorer.fname.toLowerCase().includes(searchTerm) ||
                scorer.lname.toLowerCase().includes(searchTerm) ||
                (scorer.teams && scorer.teams.some(team => team.toLowerCase().includes(searchTerm)))
            );
            renderFilteredScorers(filtered);
        }



        function renderFilteredGames(filteredGames) {
            const container = document.getElementById('gamesTable');
            if (!filteredGames.length) {
                container.innerHTML = '<div class="loading">No games found</div>';
                return;
            }

            // Clear container
            container.innerHTML = '';
            
            // Create table element
            const table = document.createElement('table');
            table.className = 'table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Date', 'Time', 'Game N', 'Gym', 'Täfeler (Team)', 'Scorer (Team)', 'Actions'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            filteredGames.forEach(game => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(game.date);
                row.appendChild(dateCell);
                
                // Time
                const timeCell = document.createElement('td');
                timeCell.textContent = formatTime(game.time);
                row.appendChild(timeCell);
                
                // Game N
                const gameNCell = document.createElement('td');
                gameNCell.textContent = game.gamen || `Game ${games.indexOf(game) + 1}`;
                row.appendChild(gameNCell);
                
                // Gym
                const gymCell = document.createElement('td');
                gymCell.textContent = game.halle || '-';
                row.appendChild(gymCell);
                
                // Täfeler
                const taefelerCell = document.createElement('td');
                let taefelerText;
                
                // Check if this is a combined scorer/täfeler game
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    taefelerText = getCombinedPersonWithTeam(game);
                    if (!taefelerText) {
                        taefelerText = `Missing assignment (${game.scorer_taefeler_team || 'Scorer/Täfeler'})`;
                    }
                } else {
                    taefelerText = getPersonWithTeam(game.taefeler_id, scorers, game.taefeler_team);
                }
                
                taefelerCell.textContent = taefelerText;
                if (taefelerText.includes('Missing assignment')) {
                    taefelerCell.className = 'missing-assignment';
                } else if (taefelerText === 'Person not found') {
                    taefelerCell.className = 'person-not-found';
                }
                row.appendChild(taefelerCell);
                
                // Scorer
                const scorerCell = document.createElement('td');
                let scorerText;
                
                // Check if this is a combined scorer/täfeler game
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    scorerText = getCombinedPersonWithTeam(game);
                    if (!scorerText) {
                        scorerText = `Missing assignment (${game.scorer_taefeler_team || 'Scorer/Täfeler'})`;
                    }
                } else {
                    scorerText = getPersonWithTeam(game.scorer_id, scorers, game.scorer_team);
                }
                
                scorerCell.textContent = scorerText;
                if (scorerText.includes('Missing assignment')) {
                    scorerCell.className = 'missing-assignment';
                } else if (scorerText === 'Person not found') {
                    scorerCell.className = 'person-not-found';
                }
                row.appendChild(scorerCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                renderActionButtons(game, actionsCell);
                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            // Add summary statistics for filtered games
            const missingTaefeler = filteredGames.filter(game => {
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    return !game.scorer_taefeler_id;
                } else {
                    return !game.taefeler_id;
                }
            }).length;
            
            const missingScorer = filteredGames.filter(game => {
                if (game.scorer_taefeler_id || game.scorer_taefeler_team) {
                    return !game.scorer_taefeler_id;
                } else {
                    return game.scorer_team && game.scorer_team.trim() !== '' && !game.scorer_id;
                }
            }).length;
            
            const totalFiltered = filteredGames.length;
            
            if (missingTaefeler > 0 || missingScorer > 0) {
                const summaryDiv = document.createElement('div');
                summaryDiv.style.marginTop = '15px';
                summaryDiv.style.padding = '10px';
                summaryDiv.style.backgroundColor = '#fff3cd';
                summaryDiv.style.border = '1px solid #ffeaa7';
                summaryDiv.style.borderRadius = '4px';
                summaryDiv.style.color = '#856404';
                
                let summaryText = `Filtered Results: ${totalFiltered} games`;
                if (missingTaefeler > 0) {
                    summaryText += `, ${missingTaefeler} missing täfeler`;
                }
                if (missingScorer > 0) {
                    summaryText += `, ${missingScorer} missing scorer`;
                }
                
                summaryDiv.textContent = summaryText;
                container.appendChild(summaryDiv);
            }
        }

        function renderFilteredScorers(filteredScorers) {
            const container = document.getElementById('scorersTable');
            if (!filteredScorers.length) {
                container.innerHTML = '<div class="loading">No scorers found</div>';
                return;
            }

            // Clear container
            container.innerHTML = '';
            
            // Create table element
            const table = document.createElement('table');
            table.className = 'table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Name', 'Phone', 'Email', 'Teams', 'Scorer Licence', 'Actions'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            filteredScorers.forEach(scorer => {
                const row = document.createElement('tr');
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = `${scorer.fname} ${scorer.lname}`;
                row.appendChild(nameCell);
                
                // Phone
                const phoneCell = document.createElement('td');
                phoneCell.textContent = scorer.phone || '-';
                row.appendChild(phoneCell);
                
                // Email
                const emailCell = document.createElement('td');
                emailCell.textContent = scorer.email || '-';
                row.appendChild(emailCell);
                
                // Teams
                const teamsCell = document.createElement('td');
                teamsCell.textContent = Array.isArray(scorer.teams) ? scorer.teams.join(', ') : scorer.teams || '-';
                row.appendChild(teamsCell);
                
                // Scorer Licence
                const licenceCell = document.createElement('td');
                licenceCell.textContent = scorer.scorer_licence ? 'Yes' : 'No';
                row.appendChild(licenceCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => editScorer(scorer.id));
                actionsCell.appendChild(editBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteScorer(scorer.id));
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        }

        // Function to handle quick assignment updates
        async function quickUpdateAssignment(matchId, field, value) {
            try {
                let updateData = {};
                if (field === 'scorer_id') {
                    updateData.scorer_id = value;
                } else if (field === 'taefeler_id') {
                    updateData.taefeler_id = value;
                }
                
                if (Object.keys(updateData).length > 0) {
                    const { error } = await supabase
                        .from('scorer_matches')
                        .update(updateData)
                        .eq('match_id', matchId);
                    
                    if (error) throw error;
                    
                    // Refresh the games table
                    await loadGames();
                    renderGamesTable();
                }
            } catch (error) {
                console.error('Error updating assignment:', error);
                alert('Error updating assignment: ' + error.message);
            }
        }

        // Function to render action buttons based on user permissions
        function renderActionButtons(game, actionsCell) {
            if (canUpdateAssignments()) {
                // Admin users get full edit/delete access
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => editGame(game.match_id));
                actionsCell.appendChild(editBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteGame(game.match_id));
                actionsCell.appendChild(deleteBtn);
            } else {
                // Non-admin users can only update assignments
                const updateAssignmentsBtn = document.createElement('button');
                updateAssignmentsBtn.className = 'btn btn-secondary';
                updateAssignmentsBtn.textContent = 'Update Assignments';
                updateAssignmentsBtn.addEventListener('click', () => showAssignmentUpdateModal(game));
                actionsCell.appendChild(updateAssignmentsBtn);
            }
        }

        // Function to show assignment update modal for non-admin users
        function showAssignmentUpdateModal(game) {
            // Create a simple modal for updating assignments
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '500px';
            
            // Check if this is a combined scorer/täfeler game
            const isCombinedGame = game.scorer_taefeler_id || game.scorer_taefeler_team;
            
            modalContent.innerHTML = `
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>Update Assignments for Game</h2>
                <p><strong>${game.gamen || `Game ${games.indexOf(game) + 1}`}</strong> on ${formatDate(game.date)} at ${formatTime(game.time)}</p>
                
                ${isCombinedGame ? `
                <div class="form-group">
                    <label>Scorer/Täfeler (${game.scorer_taefeler_team || 'Scorer/Täfeler'}):</label>
                    <select id="quickScorerTaefelerId">
                        <option value="">Select Scorer/Täfeler</option>
                        ${scorers.map(person => `<option value="${person.id}" ${game.scorer_taefeler_id === person.id ? 'selected' : ''}>${person.fname} ${person.lname}</option>`).join('')}
                    </select>
                </div>
                ` : `
                <div class="form-group">
                    <label>Täfeler (${game.taefeler_team || 'TBD'}):</label>
                    <select id="quickTaefelerId">
                        <option value="">Select Täfeler</option>
                        ${scorers.map(person => `<option value="${person.id}" ${game.taefeler_id === person.id ? 'selected' : ''}>${person.fname} ${person.lname}</option>`).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Scorer (${game.scorer_team || 'TBD'}):</label>
                    <select id="quickScorerId">
                        <option value="">Select Scorer</option>
                        ${scorers.map(person => `<option value="${person.id}" ${game.scorer_id === person.id ? 'selected' : ''}>${person.fname} ${person.lname}</option>`).join('')}
                    </select>
                </div>
                `}
                
                <button class="btn btn-success" onclick="saveQuickAssignments('${game.match_id}', ${isCombinedGame})">Save Assignments</button>
                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">Cancel</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // Function to save quick assignments
        async function saveQuickAssignments(matchId, isCombinedGame) {
            let taefelerId = null;
            let scorerId = null;

            if (isCombinedGame) {
                const scorerTaefelerId = document.getElementById('quickScorerTaefelerId').value || null;
                // For combined games, we need to update the scorer_taefeler_id field
                try {
                    const { error } = await supabase
                        .from('scorer_matches')
                        .update({ scorer_taefeler_id: scorerTaefelerId })
                        .eq('match_id', matchId);
                    
                    if (error) throw error;
                    
                    // Refresh the games table
                    await loadGames();
                    renderGamesTable();
                    
                    // Close the modal
                    document.querySelector('.modal').remove();
                    alert('Scorer/Täfeler assignment updated successfully!');
                    return;
                } catch (error) {
                    alert('Error updating scorer/täfeler assignment: ' + error.message);
                    return;
                }
            } else {
                taefelerId = document.getElementById('quickTaefelerId').value || null;
                scorerId = document.getElementById('quickScorerId').value || null;
            }
            
            try {
                const result = await updateScorerAssignments(matchId, scorerId, taefelerId);
                
                if (result.success) {
                    // Close the modal
                    document.querySelector('.modal').remove();
                    alert('Assignments updated successfully!');
                } else {
                    alert('Error updating assignments: ' + result.error);
                }
            } catch (error) {
                alert('Error updating assignments: ' + error.message);
            }
        }
    </script>
</body>
</html>
