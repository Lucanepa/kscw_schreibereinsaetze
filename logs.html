<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs - Schreibereinsätze</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center; }
        .content { padding: 20px; }
        .filters { background: #ecf0f1; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .filter-group { display: inline-block; margin-right: 20px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .filter-group input, .filter-group select { padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #3498db; color: white; }
        .btn:hover { background: #2980b9; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background: #34495e; color: white; }
        .table tr:hover { background: #f8f9fa; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error { color: #e74c3c; margin-top: 10px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #3498db; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>System Logs</h1>
            <p>View all system activity and changes</p>
        </div>
        
        <div class="content">
            <a href="admin.html" class="back-link">← Back to Admin Panel</a>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Action Type:</label>
                    <select id="actionFilter" onchange="filterLogs()">
                        <option value="">All Actions</option>
                        <option value="CREATE">Create</option>
                        <option value="UPDATE">Update</option>
                        <option value="DELETE">Delete</option>
                        <option value="SYSTEM">System</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Table:</label>
                    <select id="tableFilter" onchange="filterLogs()">
                        <option value="">All Tables</option>
                        <option value="scorer_matches">Games</option>
                        <option value="scorer_scorers">Scorers</option>
                        <option value="system_events">System Events</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date:</label>
                    <input type="date" id="dateFilter" onchange="filterLogs()">
                </div>
                
                <div class="filter-group">
                    <label>Search:</label>
                    <input type="text" id="searchFilter" placeholder="Search in logs..." oninput="filterLogs()">
                </div>
                
                <button class="btn" onclick="clearFilters()">Clear Filters</button>
            </div>
            
            <div id="logsTable"></div>
        </div>
    </div>

    <script>
        let supabase;
        let allLogs = [];
        let filteredLogs = [];

        // Helper function to escape HTML and prevent XSS
        function escapeHtml(text) {
            if (text == null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('Configuration not loaded');
                }
                
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                // Check authentication before loading logs
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    // Not authenticated, show login prompt
                    document.getElementById('logsTable').innerHTML = '<div class="error">Please log in to view logs. <a href="admin.html">Go to Admin Panel</a></div>';
                    return;
                }
                
                // Check if user is admin (you may need to implement this based on your auth system)
                // For now, we'll assume any authenticated user can view logs
                // You can add additional role checks here
                
                await loadLogs();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('logsTable').innerHTML = '<div class="error">Configuration error. Please check setup.</div>';
            }
        });

        // Load logs
        async function loadLogs() {
            try {
                const { data: logs, error } = await supabase
                    .from('scorer_edit_log')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(1000); // Load more logs for filtering

                if (error) throw error;
                
                allLogs = logs || [];
                filteredLogs = [...allLogs];
                renderLogsTable();
            } catch (error) {
                document.getElementById('logsTable').innerHTML = `<div class="error">Error loading logs: ${error.message}</div>`;
            }
        }

        // Filter logs
        function filterLogs() {
            const actionFilter = document.getElementById('actionFilter').value;
            const tableFilter = document.getElementById('tableFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredLogs = allLogs.filter(log => {
                // Action filter
                if (actionFilter && log.action !== actionFilter) return false;
                
                // Table filter
                if (tableFilter && log.table_name !== tableFilter) return false;
                
                // Date filter
                if (dateFilter) {
                    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                    if (logDate !== dateFilter) return false;
                }
                
                // Search filter
                if (searchFilter) {
                    const searchableText = [
                        log.action || '',
                        log.table_name || '',
                        log.field_name || '',
                        typeof log.old_value === 'string' ? log.old_value : JSON.stringify(log.old_value || ''),
                        typeof log.new_value === 'string' ? log.new_value : JSON.stringify(log.new_value || ''),
                        log.client_ip || '',
                        log.session_id || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchFilter)) return false;
                }
                
                return true;
            });

            renderLogsTable();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('actionFilter').value = '';
            document.getElementById('tableFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            filteredLogs = [...allLogs];
            renderLogsTable();
        }

        // Render logs table
        function renderLogsTable() {
            const container = document.getElementById('logsTable');
            
            if (!filteredLogs.length) {
                container.innerHTML = '<div class="loading">No logs found matching the current filters</div>';
                return;
            }

            // Clear container
            container.innerHTML = '';
            
            // Create table element
            const table = document.createElement('table');
            table.className = 'table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Timestamp', 'Action', 'Table', 'Field', 'Old Value', 'New Value', 'IP Address', 'Session ID', 'User Agent'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                
                // Timestamp
                const timestampCell = document.createElement('td');
                timestampCell.textContent = new Date(log.timestamp).toLocaleString();
                row.appendChild(timestampCell);
                
                // Action
                const actionCell = document.createElement('td');
                const actionStrong = document.createElement('strong');
                actionStrong.textContent = log.action;
                actionCell.appendChild(actionStrong);
                row.appendChild(actionCell);
                
                // Table
                const tableCell = document.createElement('td');
                tableCell.textContent = log.table_name;
                row.appendChild(tableCell);
                
                // Field
                const fieldCell = document.createElement('td');
                fieldCell.textContent = log.field_name || '-';
                row.appendChild(fieldCell);
                
                // Old Value
                const oldValueCell = document.createElement('td');
                const oldValue = log.old_value || '';
                const oldValueText = typeof oldValue === 'string' ? oldValue : JSON.stringify(oldValue);
                oldValueCell.title = oldValueText;
                oldValueCell.textContent = oldValueText.length > 50 ? oldValueText.substring(0, 50) + '...' : oldValueText;
                row.appendChild(oldValueCell);
                
                // New Value
                const newValueCell = document.createElement('td');
                const newValue = log.new_value || '';
                const newValueText = typeof newValue === 'string' ? newValue : JSON.stringify(newValue);
                newValueCell.title = newValueText;
                newValueCell.textContent = newValueText.length > 50 ? newValueText.substring(0, 50) + '...' : newValueText;
                row.appendChild(newValueCell);
                
                // IP Address
                const ipCell = document.createElement('td');
                ipCell.textContent = log.client_ip || '-';
                row.appendChild(ipCell);
                
                // Session ID
                const sessionCell = document.createElement('td');
                const sessionText = log.session_id || '';
                sessionCell.title = sessionText;
                sessionCell.textContent = sessionText.length > 20 ? sessionText.substring(0, 20) + '...' : sessionText;
                row.appendChild(sessionCell);
                
                // User Agent
                const userAgentCell = document.createElement('td');
                const userAgentText = log.user_agent || '';
                userAgentCell.title = userAgentText;
                userAgentCell.textContent = userAgentText.length > 30 ? userAgentText.substring(0, 30) + '...' : userAgentText;
                row.appendChild(userAgentCell);
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            // Add summary
            const summary = document.createElement('div');
            summary.style.marginTop = '20px';
            summary.style.textAlign = 'center';
            summary.style.color = '#7f8c8d';
            summary.textContent = `Showing ${filteredLogs.length} of ${allLogs.length} total logs`;
            container.appendChild(summary);
        }
    </script>
</body>
</html>
